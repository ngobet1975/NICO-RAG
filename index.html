<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NICO-RAG â€” Page de dÃ©marrage</title>
  <style>
    :root{--bd:#e6e6e6;--bg:#f7f7f7;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;margin:24px;color:#1a1a1a}
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    h1{margin:0}
    .chip{padding:4px 10px;border-radius:999px;background:#eef;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--bd);border-radius:12px;padding:16px;background:white}
    pre{background:var(--bg);padding:12px;border-radius:8px;overflow:auto;max-height:380px}
    button{padding:10px 14px;border-radius:8px;border:1px solid var(--bd);cursor:pointer;background:white}
    button.primary{background:#f4f6ff;border-color:#c9d0ff}
    footer{margin-top:22px;color:#666;font-size:12px}
    code{background:#fafafa;padding:0 4px;border-radius:4px}
    /* mini styles chat */
    #chatLog{border:1px solid var(--bd);border-radius:10px;background:#fafafa;height:320px;overflow:auto;padding:10px;white-space:pre-wrap}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .bubble{display:inline-block;max-width:80%;padding:8px 12px;border:1px solid var(--bd);border-radius:12px;margin:6px 0}
    .me{background:#e8f2ff}
    .bot{background:#fff}
    .who{opacity:.6;font-size:.8rem;margin-bottom:2px}
    #chatInput{flex:1;padding:10px;border:1px solid var(--bd);border-radius:10px}
    #sendBtn{background:#2563eb;color:#fff;border-color:#2563eb}
  </style>
</head>
<body>
  <header>
    <h1>NICO-RAG</h1>
    <span class="chip">SWA + Entra ID</span>
    <span class="chip">MSAL â†’ API</span>
  </header>

  <div class="grid">
    <section class="card">
      <h2>IdentitÃ© (/.auth/me)</h2>
      <p>Vous Ãªtes connectÃ© via Microsoft Entra ID. Les infos ci-dessous viennent de <code>/.auth/me</code> (SWA).</p>
      <pre id="me">Chargementâ€¦</pre>
      <div class="row">
        <button onclick="location.href='/.auth/logout'">Se dÃ©connecter</button>
        <button class="primary" id="btnReloadMe">RafraÃ®chir</button>
      </div>
    </section>

    <section class="card">
      <h2>Appel API protÃ©gÃ©</h2>
      <p>La SPA obtient un jeton via <strong>MSAL</strong> avec le scope :
        <code>api://d4663603-4c77-4acf-95f3-c1f5d0390ae1/user_impersonation</code> puis appelle lâ€™API.</p>
      <div class="row">
        <button class="primary" id="btnCall">Tester lâ€™appel API</button>
        <button id="btnClear">Nettoyer</button>
      </div>
      <pre id="api">En attenteâ€¦</pre>
    </section>
  </div>

  <!-- === Nouveau : Chat Azure OpenAI (sous le contenu existant) === -->
  <section class="card" style="margin-top:16px">
    <h2>Chat Azure OpenAI</h2>
    <p>Cette zone envoie vos messages Ã  lâ€™API (<code>/chat</code>) avec un jeton MSAL. Le backend appelle votre dÃ©ploiement Azure OpenAI.</p>
    <div id="chatLog"></div>
    <div class="row" style="margin-top:10px">
      <input id="chatInput" placeholder="Posez une question (ex : Â« Mon agenda cette semaine ? Â»)"/>
      <button id="sendBtn">Envoyer</button>
      <label style="display:flex;align-items:center;gap:6px">
        <input type="checkbox" id="includeProfile"/> Inclure mon profil Graph
      </label>
      <button id="clearChat">Effacer</button>
    </div>
  </section>

  <footer>
    POC France Central Â· SWA authentifiÃ©e Â· API App Service protÃ©gÃ©e (Easy Auth) Â· OBO Graph Ã  venir.
  </footer>

  <!-- Chargement MSAL avec fallback CDN -->
  <script>
    function loadScript(src){
      return new Promise((res,rej)=>{
        const s=document.createElement('script'); s.src=src; s.async=true;
        s.onload=res; s.onerror=()=>rej(new Error('Ã‰chec de chargement: '+src));
        document.head.appendChild(s);
      });
    }
    (async () => {
      try { await loadScript("https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"); }
      catch(e1){ console.warn("MSAL CDN #1 KO â†’ fallback jsDelivr", e1);
        await loadScript("https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js");
      }
      startApp();
    })();
    function show(id, msg){ const el=document.getElementById(id); if(el) el.textContent = msg; }
    window.onerror = (_,src,lin,col,err)=>{ show("api", "Erreur JS: "+(err?.message||(`${src}:${lin}`))); };
  </script>

  <script>
    // ======= CONFIG (confirmÃ©e) =======
    const TENANT_ID      = "6bcca42d-d01b-4e42-be4b-2f55074eaa0d";
    const SPA_CLIENT_ID  = "37a06db0-7d71-495c-8744-f0977fc82f2e";
    const SCOPE_API      = "api://d4663603-4c77-4acf-95f3-c1f5d0390ae1/user_impersonation";
    const API_BASE       = "https://api-nico-rag.azurewebsites.net";

    function startApp(){
      if(!window.msal){ show("api","MSAL introuvable (rÃ©seau/filtrage)."); return; }

      // /.auth/me (identitÃ© SWA)
      async function loadMe(){
        try{
          const d = await (await fetch("/.auth/me")).json();
          document.getElementById("me").textContent = JSON.stringify(d,null,2);
        }catch(e){ show("me","Erreur /.auth/me: "+e); }
      }
      loadMe();
      document.getElementById("btnReloadMe")?.addEventListener("click", loadMe);

      // MSAL
      const msalInstance = new msal.PublicClientApplication({
        auth: { clientId: SPA_CLIENT_ID, authority: `https://login.microsoftonline.com/${TENANT_ID}`, redirectUri: window.location.origin },
        cache:{ cacheLocation:"sessionStorage" }
      });

      async function ensureLogin(){
        const accts = msalInstance.getAllAccounts();
        if(accts.length===0){
          const login = await msalInstance.loginPopup({ scopes:[SCOPE_API] });
          msalInstance.setActiveAccount(login.account);
          return login.account;
        }
        msalInstance.setActiveAccount(accts[0]);
        return accts[0];
      }

      async function getToken(){
        await ensureLogin();
        const req = { scopes:[SCOPE_API], account: msalInstance.getActiveAccount() };
        try { return (await msalInstance.acquireTokenSilent(req)).accessToken; }
        catch { return (await msalInstance.acquireTokenPopup(req)).accessToken; }
      }

      // ======= Appel API protÃ©gÃ© (bouton existant) =======
      async function callApi(){
        show("api","Appel en coursâ€¦");
        try{
          const token = await getToken();
          const r = await fetch(`${API_BASE}/`, { headers:{ Authorization:`Bearer ${token}` }});
          const txt = await r.text();
          show("api", `API status: ${r.status} ${r.statusText}\n`+txt.slice(0,2000));
        }catch(e){ show("api","Erreur appel API: "+e); }
      }
      document.getElementById("btnCall")?.addEventListener("click", callApi);
      document.getElementById("btnClear")?.addEventListener("click", ()=>show("api","En attenteâ€¦"));

      // ======= Chat Azure OpenAI (nouveau) =======
      const chatLog   = document.getElementById('chatLog');
      const chatInput = document.getElementById('chatInput');
      const sendBtn   = document.getElementById('sendBtn');
      const clearChat = document.getElementById('clearChat');
      const includeProfile = document.getElementById('includeProfile');

      const thread = []; // [{role:'user'|'assistant', content:'...'}]

      function escapeHtml(s){return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
      function addBubble(role, text){
        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.justifyContent = role==='user' ? 'flex-end' : 'flex-start';
        const b = document.createElement('div');
        b.className = `bubble ${role==='user'?'me':'bot'}`;
        b.innerHTML = `<div class="who">${role==='user'?'ðŸ‘¤ vous':'ðŸ¤– assistant'}</div>${escapeHtml(text)}`;
        wrap.appendChild(b);
        chatLog.appendChild(wrap);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      async function sendChat(){
        const text = (chatInput.value||"").trim();
        if(!text) return;
        chatInput.value = "";
        thread.push({ role:"user", content:text });
        addBubble('user', text);
        addBubble('assistant', 'â€¦');

        try{
          const token = await getToken();
          const r = await fetch(`${API_BASE}/chat`, {
            method: "POST",
            headers: {
              "content-type":"application/json",
              "authorization":"Bearer "+token
            },
            body: JSON.stringify({
              messages: thread,
              includeProfile: !!includeProfile.checked
            })
          });
          const data = await r.json();
          // remplace la bulle "â€¦"
          chatLog.lastChild.remove();
          const answer = data?.message?.content || data?.reply || JSON.stringify(data);
          thread.push({ role:"assistant", content: answer });
          addBubble('assistant', answer);
        }catch(e){
          chatLog.lastChild.remove();
          addBubble('assistant', `âš ï¸ Erreur: ${e}`);
        }
      }

      sendBtn?.addEventListener('click', sendChat);
      chatInput?.addEventListener('keydown', e => { if(e.key==='Enter') sendChat(); });
      clearChat?.addEventListener('click', () => { thread.length = 0; chatLog.innerHTML = ""; });
    }
  </script>
</body>
</html>
